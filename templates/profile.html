{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2 class="mb-4">User Profile</h2>

        <!-- -------------------------
             Profile Card
        ------------------------- -->
        <div id="profileCard" class="card mb-4">
            <div class="card-body">
                <p><strong>Username:</strong> <span id="username">Loading...</span></p>
                <p><strong>Email:</strong> <span id="email">Loading...</span></p>
                <p><strong>Member since:</strong> <span id="createdAt">Loading...</span></p>
            </div>
        </div>

        <!-- -------------------------
             Change Password Form
        ------------------------- -->
        <div class="card mb-3">
            <div class="card-body">
                <h4>Change Password</h4>
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="oldPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="oldPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmNewPassword" required>
                    </div>
                    <div class="mb-3">
                        <button type="submit" class="btn btn-warning">Change Password</button>
                    </div>
                </form>
                <div id="changePasswordMessage" class="d-block mt-3"></div>
            </div>
        </div>

        <!-- -------------------------
             Back to Dashboard Button
        ------------------------- -->
        <a href="/dashboard" class="btn btn-primary">Back to Dashboard</a>
    </div>
</div>

<script>
/**
 * @description Fetches user profile info from the server
 * Populates the profile card with username, email, and account creation date.
 */
async function loadProfile() {
    try {
        const res = await fetch('/auth/me', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch user info');

        const data = await res.json();
        const user = data.user;

        // Update DOM elements with user info
        document.getElementById('username').innerText = user.username;
        document.getElementById('email').innerText = user.email;

        if (user.created_at) {
            // Convert UTC to local time
            const utcDate = new Date(user.created_at + 'Z'); 
            document.getElementById('createdAt').innerText = utcDate.toLocaleString();
        } else {
            document.getElementById('createdAt').innerText = 'N/A';
        }
    } catch (err) {
        // Display error message inside profile card
        document.getElementById('profileCard').innerHTML = `
            <div class="alert alert-danger">Error loading profile: ${err.message}</div>
        `;
    }
}

// Load profile when page loads
loadProfile();

/**
 * @description Handles the change password form submission
 * - Validates new passwords match
 * - Ensures CSRF token is present
 * - Sends POST request to change password endpoint
 * - Displays success/error messages
 */
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const messageDiv = document.getElementById('changePasswordMessage');

    // Validate that new passwords match
    if (newPassword !== confirmNewPassword) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.innerText = "New passwords do not match.";
        return;
    }

    // Ensure CSRF token exists
    if (!window.csrfToken) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.innerText = "CSRF token missing. Make sure you are logged in.";
        return;
    }

    try {
        // Send password change request
        const response = await fetch('/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': window.csrfToken
            },
            credentials: 'include',
            body: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword
            })
        });

        const data = await response.json();

        // Show success or error message
        if (response.status === 200) {
            messageDiv.className = 'alert alert-success';
            messageDiv.innerText = data.message || 'Password changed successfully!';
        } else {
            messageDiv.className = 'alert alert-danger';
            messageDiv.innerText = data.error || 'Failed to change password';
        }
    } catch (err) {
        messageDiv.className = 'alert alert-danger';
        messageDiv.innerText = 'Error: ' + err.message;
    }
});

/**
 * @description Clears password form inputs if page is loaded from back/forward cache
 */
window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
        const form = document.getElementById('changePasswordForm');
        if (form) form.reset();
    }
});
</script>
{% endblock %}
