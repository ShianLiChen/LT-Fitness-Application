{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <h2 class="mb-4 text-center">Create Workout Session</h2>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="workoutTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-pane" type="button" role="tab">
                    API Search (Manual)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-pane" type="button" role="tab">
                    AI Generator (Ollama)
                </button>
            </li>
        </ul>

        <div class="tab-content" id="workoutTabContent">
            
            <!-- TAB 1: Manual API Search -->
            <div class="tab-pane fade show active" id="manual-pane" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="apiSearchInput" class="form-control" placeholder="Search exercise (e.g., Bench Press)">
                            <select class="form-select" id="muscleSelect" style="max-width: 200px;">
                                <option value="">All Muscles</option>
                                <option value="chest">Chest</option>
                                <option value="back">Back</option>
                                <option value="legs">Legs</option>
                                <option value="abs">Abs</option>
                                <option value="cardio">Cardio</option>
                            </select>
                            <button class="btn btn-primary" type="button" onclick="searchExercises()">Search</button>
                        </div>
                        <div id="searchResults" class="list-group mb-3" style="max-height: 200px; overflow-y:auto;">
                            <!-- Search results go here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: AI Generation -->
            <div class="tab-pane fade" id="ai-pane" role="tabpanel">
                <div class="card mb-4 bg-light border-info">
                    <div class="card-body">
                        <label class="form-label fw-bold">Ask Luna (AI Trainer)</label>
                        <textarea id="aiPrompt" class="form-control mb-3" rows="3" placeholder="e.g., Create a high intensity leg workout with 4 exercises"></textarea>
                        <button class="btn btn-info text-white" onclick="generateAIWorkout()">Generate Plan</button>
                        <div id="aiLoading" class="d-none ms-2 spinner-border spinner-border-sm text-info"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Staging Area (Where selected exercises go) -->
        <div class="card shadow border-primary">
            <div class="card-header bg-primary text-white">
                Current Session Plan
            </div>
            <div class="card-body">
                <form id="workoutForm">
                    <table class="table table-bordered" id="stagingTable">
                        <thead>
                            <tr>
                                <th>Exercise</th>
                                <th width="10%">Sets</th>
                                <th width="10%">Reps</th>
                                <th width="10%">Lbs</th>
                                <th width="12%">Mins</th> <!-- NEW COLUMN -->
                                <th>Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Exercises added here -->
                        </tbody>
                    </table>
                    <p id="emptyMsg" class="text-muted text-center">No exercises added yet.</p>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-lg" onclick="saveAllWorkouts()">
                            Save Workout Session
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<script>
// 1. API Ninjas Search Logic
async function searchExercises() {
    const query = document.getElementById('apiSearchInput').value;
    const muscle = document.getElementById('muscleSelect').value;
    const resultsDiv = document.getElementById('searchResults');
    
    resultsDiv.innerHTML = '<div class="text-center p-2">Searching...</div>';

    try {
        // REMOVED THE HEADERS OBJECT HERE
        const res = await fetch(`/workouts/api/search-exercises?query=${query}&muscle=${muscle}`);
        
        if (!res.ok) throw new Error("Request failed"); // Good practice to check this

        const data = await res.json();

        resultsDiv.innerHTML = '';
        if (data.length === 0) {
            resultsDiv.innerHTML = '<div class="p-2 text-muted">No results found.</div>';
            return;
        }

        data.forEach(ex => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            // Added 'difficulty' to the arguments below
            item.onclick = () => addToStaging(ex.name, '', '', '', `Difficulty: ${ex.difficulty}`);
            item.innerHTML = `<span><strong>${ex.name}</strong> <small class="text-muted">(${ex.muscle})</small></span> <span class="badge bg-primary">+ Add</span>`;
            resultsDiv.appendChild(item);
        });

    } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = '<div class="text-danger p-2">Error fetching exercises. Check console.</div>';
    }
}

// 2. AI Logic
async function generateAIWorkout() {
    const prompt = document.getElementById('aiPrompt').value;
    const loading = document.getElementById('aiLoading');
    
    if(!prompt) return alert("Please enter a prompt");
    
    loading.classList.remove('d-none');
    
    try {
        const res = await fetch('/workouts/api/generate-workout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': window.csrfToken
            },
            body: JSON.stringify({ prompt: prompt })
        });
        const data = await res.json();
        
        // Parse the JSON response from AI
        try {
            // The proxy returns a string, we assume it's valid JSON array per system prompt
            const exercises = JSON.parse(data.response);
            exercises.forEach(ex => {
                addToStaging(ex.exercise_name, ex.sets, ex.reps, '', ex.notes);
            });
        } catch (parseErr) {
            alert("AI response was not valid JSON, but check console.");
            console.log(data.response);
        }

    } catch (err) {
        alert("Failed to generate workout");
    } finally {
        loading.classList.add('d-none');
    }
}

// 3. Staging Area Logic
function addToStaging(name, sets, reps, weight, notes) {
    document.getElementById('emptyMsg').style.display = 'none';
    const tbody = document.querySelector('#stagingTable tbody');
    
    // Default duration is 15 mins
    const defaultDuration = 15;

    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" class="form-control" value="${name}" readonly data-key="exercise_name"></td>
        <td><input type="number" class="form-control" value="${sets || ''}" data-key="sets" placeholder="0"></td>
        <td><input type="number" class="form-control" value="${reps || ''}" data-key="reps" placeholder="0"></td>
        <td><input type="number" class="form-control" value="${weight || ''}" data-key="weight_lbs" placeholder="0"></td>
        <!-- NEW DURATION INPUT -->
        <td><input type="number" class="form-control" value="${defaultDuration}" data-key="duration_minutes"></td>
        <td><input type="text" class="form-control" value="${notes || ''}" data-key="notes"></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">X</button></td>
    `;
    tbody.appendChild(tr);
}

// 4. Save Batch Logic
async function saveAllWorkouts() {
    const rows = document.querySelectorAll('#stagingTable tbody tr');
    if(rows.length === 0) return alert("No exercises to save!");

    const payload = [];
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const item = {};
        inputs.forEach(input => {
            item[input.dataset.key] = input.value;
        });
        payload.push(item);
    });

    try {
        const res = await fetch('/workouts/batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': window.csrfToken
            },
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            alert("Workout session saved!");
            window.location.href = '/workouts/ui'; // Redirect to list
        } else {
            alert("Error saving workouts");
        }
    } catch (err) {
        console.error(err);
    }
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}
</script>
{% endblock %}